<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title }}</title>
    <style>
      {{ css|safe }}
      :root { --btn-color: {{ button_color }}; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>{{ title }}</h1>
      <div class="slide" id="slide">
        <img id="img" src="{{ first_src }}" alt="slide" />
      </div>
      <div class="toolbar">
        <button id="prev" class="btn btn-secondary"><span class="chev">‹</span> Voltar</button>
        <div class="progress"><span id="pos">1</span> de <span id="total">{{ total }}</span></div>
        <button id="next" class="btn btn-primary">Próximo <span class="chev">›</span></button>
      </div>

      <div class="final" id="final">
        <div id="final-content" class="final-content">{{ final_message_html | safe }}</div>
        <div style="margin-top: 12px;">
          <button id="exit" class="btn btn-primary">Sair da Apresentação</button>
        </div>
      </div>
    </div>

    <script>
      {{ js|safe }}
    </script>
    <script>
      const slides = {{ slides_json | safe }};
      let idx = 0;
      const total = slides.length;
      const img = document.getElementById('img');
      const pos = document.getElementById('pos');
      const totalEl = document.getElementById('total');
      const next = document.getElementById('next');
      const prev = document.getElementById('prev');
      const final = document.getElementById('final');
      const slide = document.getElementById('slide');
      const toolbar = document.querySelector('.toolbar');
      const progressEl = document.querySelector('.progress');
      const exitBtn = document.getElementById('exit');
      totalEl.textContent = total;

      function update() {
        pos.textContent = Math.min(idx + 1, total);
        prev.disabled = idx <= 0;
        next.disabled = (total === 0);
        if (idx < total) {
          img.src = slides[idx].src;
          slide.style.display = 'flex';
          final.style.display = 'none';
          if (toolbar) toolbar.style.display = 'flex';
          if (progressEl) progressEl.style.display = 'block';
          if (next) next.style.display = 'inline-flex';
        } else {
          // tela final
          slide.style.display = 'none';
          final.style.display = 'block';
          if (window.SCORM) { window.SCORM.complete(); }
          if (toolbar) toolbar.style.display = 'flex';
          if (progressEl) progressEl.style.display = 'none';
          if (next) next.style.display = 'none';
          if (prev) prev.disabled = false;
        }
      }

      next.addEventListener('click', () => {
        idx = Math.min(idx + 1, total); // vai até total para disparar final
        update();
      });
      prev.addEventListener('click', () => {
        idx = Math.max(idx - 1, 0);
        update();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') { next.click(); }
        if (e.key === 'ArrowLeft') { prev.click(); }
      });
      exitBtn.addEventListener('click', () => {
        if (window.SCORM) { window.SCORM.finish(); }
      });

      // init
      if (window.SCORM) { window.SCORM.init(); }
      update();
    </script>
  </body>
</html>
